---
- hosts: 10.63.243.17
  remote_user: zte
  become: yes
  become_method: sudo
  vars:
    update_path: "/tmp/testapi"
    image: "serenafeng/testapi"
    mongodb_url: "mongodb://10.63.243.17:27017"
    swagger_url: "http://10.63.243.17:8002"
    port: "8002"
  tasks:
    - name: create temporary update directory
      file:
        path: "{{ update_path }}"
        state: directory
    - name: transfer files in templates
      copy:
        src: templates/
        dest: "{{ update_path }}"
    - name: backup mongodb database
      command: "python {{ update_path }}/backup_mongodb.py -u {{ mongodb_url }} -o {{ update_path }}"
    - name: stop and remove old containers
      command: bash "{{ update_path }}/rm_containers.sh"
    - name: delete old docker images
      command: docker rmi "{{ image }}"
    - name: update mongodb
      command: "python {{ update_path }}/update_mongodb.py -u {{ mongodb_url }}"
    - name: docker start testapi server
      command: docker run -dti -p "{{ port }}:8000"
               -e "mongodb_url={{ mongodb_url }}"
               -e "swagger_url={{ swagger_url }}"
               "{{ image }}"
    - name: remove temporary update directory
      file:
        path: "{{ update_path }}"
        state: absent





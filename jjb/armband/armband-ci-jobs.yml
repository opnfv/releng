# jenkins job templates for Armband
- project:
    name: 'armband-ci'
    project: '{name}'
    installer: 'fuel'

#--------------------------------
# BRANCH ANCHORS
#--------------------------------
    master: &master
        stream: master
        branch: '{stream}'
        gs-pathname: ''
        pod-default-bridge: 'pxebr'
    brahmaputra: &brahmaputra
        stream: brahmaputra
        branch: 'stable/{stream}'
        gs-pathname: '/{stream}'
        pod-default-bridge: 'pxebr'
#--------------------------------
# POD, INSTALLER, AND BRANCH MAPPING
#--------------------------------
#        brahmaputra
#--------------------------------
    pod:
        - arm-pod1:
            <<: *brahmaputra
            pod-default-bridge: 'admin6_br0,public6_br0'
#--------------------------------
#        master
#--------------------------------
# No master deploys for now
#        - arm-pod1:
#            <<: *master
#            pod-default-bridge: 'admin6_br0,public6_br0'
#--------------------------------
#       scenarios
#--------------------------------
    scenario:
        # HA scenarios
        - 'os-odl_l2-nofeature-ha':
            auto-trigger-name: 'armband-{scenario}-{pod}-{stream}-trigger'

        # NOHA scenarios
        - 'os-odl_l2-nofeature-noha':
            auto-trigger-name: 'brahmaputra-trigger-daily-disabled'

    jobs:
        - 'armband-{scenario}-{pod}-daily-{stream}'
        - 'armband-deploy-{pod}-daily-{stream}'

########################
# job templates
########################
- job-template:
    name: 'armband-{scenario}-{pod}-daily-{stream}'

    concurrent: false

    properties:
        - throttle:
            enabled: true
            max-total: 1
            max-per-node: 1
        - build-blocker:
            use-build-blocker: true
            blocking-jobs:
                - 'armband-os-.*?-{pod}-daily-{stream}'
            block-level: 'NODE'

    wrappers:
        - build-name:
            name: '$BUILD_NUMBER - Scenario: $DEPLOY_SCENARIO'

    triggers:
        - '{auto-trigger-name}'

    parameters:
        - project-parameter:
            project: '{project}'
        - '{installer}-defaults'
        - '{pod}-defaults':
            installer: '{installer}'
        - string:
            name: DEPLOY_SCENARIO
            default: '{scenario}'
        - armband-ci-parameter:
            gs-pathname: '{gs-pathname}'
            pod-default-bridge: '{pod-default-bridge}'

    builders:
        - trigger-builds:
            - project: 'armband-deploy-{pod}-daily-{stream}'
              current-parameters: false
              predefined-parameters:
                DEPLOY_SCENARIO={scenario}
              same-node: true
              block: true
        - trigger-builds:
            - project: 'functest-armband-{pod}-daily-{stream}'
              current-parameters: false
              predefined-parameters:
                DEPLOY_SCENARIO={scenario}
              block: true
              same-node: true
              block-thresholds:
                build-step-failure-threshold: 'never'
                failure-threshold: 'never'
                unstable-threshold: 'FAILURE'

- job-template:
    name: 'armband-deploy-{pod}-daily-{stream}'

    concurrent: false

    properties:
        - throttle:
            enabled: true
            max-total: 1
            max-per-node: 1
        - build-blocker:
            use-build-blocker: true
            blocking-jobs:
                - 'armband-deploy-{pod}-daily-{stream}'
                - 'armband-deploy-generic-daily-.*'
            block-level: 'NODE'

    parameters:
        - project-parameter:
            project: '{project}'
        - '{installer}-defaults'
        - '{pod}-defaults':
            installer: '{installer}'
        - string:
            name: DEPLOY_SCENARIO
            default: 'os-odl_l2-nofeature-ha'
        - armband-ci-parameter:
            gs-pathname: '{gs-pathname}'
            pod-default-bridge: '{pod-default-bridge}'

    scm:
        - git-scm:
            credentials-id: '{ssh-credentials}'
            refspec: ''
            branch: '{branch}'

    wrappers:
        - build-name:
            name: '$BUILD_NUMBER - Scenario: $DEPLOY_SCENARIO'

    builders:
        - shell:
            !include-raw-escape: ./armband-download-artifact.sh
        - shell:
            !include-raw-escape: ./armband-deploy.sh

    publishers:
        - email:
            recipients: josep.puigdemont@enea.com armband@enea.com

########################
# parameter macros
########################
- parameter:
    name: armband-ci-parameter
    parameters:
        - string:
            name: BUILD_DIRECTORY
            default: $WORKSPACE/build_output
            description: "Directory where the build artifact will be located upon the completion of the build."
        - string:
            name: CACHE_DIRECTORY
            default: $HOME/opnfv/cache/$INSTALLER_TYPE
            description: "Directory where the cache to be used during the build is located."
        - string:
            name: GS_URL
            default: artifacts.opnfv.org/$PROJECT{gs-pathname}
            description: "URL to Google Storage."
        - string:
            name: LAB_CONFIG_URL
            default: file://$HOME/opnfv/repos/lab-config
            description: "URL for the lab configuration, passed to the deploy script as -b"
        - string:
            name: DEFAULT_BRIDGE
            default: {pod-default-bridge}
            description: "The bridge to use for Fuel PXE booting. It can be a comma sparated list of bridges, in which case the first is the PXE boot bridge, and all subsequent interfaces that will be added to the VM. If left empty, most deploy scripts will default to pxebr."

########################
# trigger macros
########################
# CI PODs
#----------------------------------------------------------
# Enea Armband POD 1 Triggers running against master branch
#----------------------------------------------------------
# No triggers for master for now
- trigger:
    name: 'armband-os-odl_l2-nofeature-ha-arm-pod1-master-trigger'
    triggers:
        - timed: ''

#---------------------------------------------------------------
# Enea Armband POD 1 Triggers running against brahmaputra branch
#---------------------------------------------------------------
- trigger:
    name: 'armband-os-odl_l2-nofeature-ha-arm-pod1-brahmaputra-trigger'
    triggers:
        - timed: '0 6 * * *'

###################################################
# verify and artifacts upload jobs for bottlenecks
###################################################
- project:
    name: bottlenecks-project-jobs

    project: 'bottlenecks'

    jobs:
        - 'bottlenecks-verify-{stream}'
        - 'bottlenecks-{suite}-upload-artifacts-{stream}'
    
    suite:
        - 'rubbos'
        - 'vstf'

# only master branch is enabled at the moment to keep no of jobs sane
    stream:
        - master:
            branch: 'master'
            gs-pathname: ''
#        - brahmaputra:
#            branch: 'stable/brahmaputra'
#            gs-pathname: '/brahmaputra'

- job-template:
    name: 'bottlenecks-verify-{stream}'

    parameters:
        - project-parameter:
            project: '{project}'
        - gerrit-parameter:
            branch: '{branch}'
        - 'opnfv-build-defaults'

    scm:
        - gerrit-trigger-scm:
            credentials-id: '{ssh-credentials}'
            refspec: '$GERRIT_REFSPEC'
            choosing-strategy: 'gerrit'

    triggers:
        - gerrit:
            trigger-on:
                - patchset-created-event:
                    exclude-drafts: 'false'
                    exclude-trivial-rebase: 'false'
                    exclude-no-code-change: 'false'
                - draft-published-event
                - comment-added-contains-event:
                    comment-contains-value: 'recheck'
                - comment-added-contains-event:
                    comment-contains-value: 'reverify'
            projects:
              - project-compare-type: 'ANT'
                project-pattern: '{project}'
                branches:
                  - branch-compare-type: 'ANT'
                    branch-pattern: '**/{branch}'
                forbidden-file-paths:
                  - compare-type: ANT
                    pattern: 'docs/**|.gitignore'

    builders:
        - shell: |
            echo "Nothing to verify!"

- job-template:
    name: 'bottlenecks-{suite}-upload-artifacts-{stream}'

    node: ericsson-build

    concurrent: true

    properties:
        - throttle:
            enabled: true
            max-total: 1
            max-per-node: 1

    parameters:
        - project-parameter:
            project: '{project}'
        - 'ericsson-ca-build-1-defaults'
        - bottlenecks-artifacts-parameter:
            suite: '{suite}'

    scm:
        - git-scm:
            credentials-id: '{ssh-credentials}'
            refspec: ''
            branch: '{branch}'

    builders:
        - 'bottlenecks-builder-upload-artifact'
        - 'bottlenecks-workspace-cleanup'

####################
# parameter macros
####################
- parameter:
    name: bottlenecks-artifacts-parameter
    parameters:
        - string:
           name: CACHE_DIR
           default: $WORKSPACE/cache/{suite}
           description: "the cache to store packages downloaded from public IP"
        - string:
           name: SUITE_URL
           default: gs://artifacts.opnfv.org/bottlenecks/{suite}
           description: "LF artifacts url for storage of bottlenecks packages"
        - string:
           name: PACKAGE_URL
           default: http://205.177.226.237:9999/bottlenecks/{suite}/
           description: "the url where we store the packages used for bottlenecks rubbos"

- builder:
    name: bottlenecks-builder-upload-artifact
    builders:
        - shell: |
            #!/bin/bash
            set -o errexit

            echo "Bottlenecks: upload to artifacts from the public IP"

            [[ -d $CACHE_DIR ]] || mkdir -p $CACHE_DIR

            for file in $(curl -s $PACKAGE_URL |
                               grep href |
                               sed 's/.*href="//' |
                               sed 's/".*//' |
                               grep '^[a-zA-Z].*'); do
                 curl --connect-timeout 10 -o $CACHE_DIR/$file $PACKAGE_URL$file -v
                 echo "bottlenecks: copy file $CACHE_DIR/$file to $SUITE_URL"
                 gsutil cp $CACHE_DIR/$file $SUITE_URL
            done

- builder:
    name: bottlenecks-workspace-cleanup
    builders:
        - shell: |
            #!/bin/bash
            set -o errexit

            echo "Bottlenecks: cleanup cache used for storage downloaded packages"

            /bin/rm -rf $CACHE_DIR

####################################
# job configuration for bottlenecks
####################################
- project:
    name: bottlenecks-ci-jobs

    project: 'bottlenecks'

#--------------------------------
# BRANCH ANCHORS
#--------------------------------
    master: &master
        stream: master
        branch: '{stream}'
        #This is used for common project file storage
        gs-pathname: ''
        #This is used for different test suite dependent packages storage
        gs-packagepath: '/{suite}'
        #docker tag used for version control
        docker-tag: 'latest'
    danube: &danube
        stream: danube
        branch: 'stable/{stream}'
        gs-pathname: '/{stream}'
        gs-packagepath: '/{stream}/{suite}'
        docker-tag: 'stable'
#--------------------------------
# POD, INSTALLER, AND BRANCH MAPPING
#--------------------------------
#    Installers using labels
#            CI PODs
# This section should only contain the installers
# that have been switched using labels for slaves
#--------------------------------
    pod:
#compass CI PODs
        - baremetal:
            slave-label: compass-baremetal
            installer: compass
            auto-trigger-name: 'daily-trigger-disabled'
            <<: *master
        - virtual:
            slave-label: compass-virtual
            installer: compass
            auto-trigger-name: 'daily-trigger-disabled'
            <<: *master
        - baremetal:
            slave-label: compass-baremetal
            installer: compass
            auto-trigger-name: 'daily-trigger-disabled'
            <<: *danube
        - virtual:
            slave-label: compass-virtual
            installer: compass
            auto-trigger-name: 'daily-trigger-disabled'
            <<: *danube

#--------------------------------
#        None-CI PODs
#--------------------------------
       # - orange-pod2:
       #     slave-label: '{pod}'
       #     installer: joid
       #     auto-trigger-name: 'daily-trigger-disabled'
       #     <<: *danube
       # - orange-pod2:
       #     slave-label: '{pod}'
       #     installer: joid
       #     auto-trigger-name: 'daily-trigger-disabled'
       #     <<: *master
#--------------------------------------------
    suite:
        - 'rubbos'
        - 'vstf'
        - 'posca_stress_traffic'

    jobs:
        - 'bottlenecks-{installer}-{suite}-{pod}-daily-{stream}'

################################
# job templates
################################
- job-template:
    name: 'bottlenecks-{installer}-{suite}-{pod}-daily-{stream}'

    wrappers:
        - build-name:
            name: '$BUILD_NUMBER - Scenario: $DEPLOY_SCENARIO'
        - timeout:
            timeout: 180
            abort: true

    triggers:
        - '{auto-trigger-name}'

    parameters:
        - project-parameter:
            project: '{project}'
            branch: '{branch}'
        - '{slave-label}-defaults'
        - '{installer}-defaults'
        - 'bottlenecks-params-{slave-label}'
        - string:
            name: REPO_DIR
            default: "/home/opnfv/bottlenecks"
            description: "Directory where the repository is cloned"
        - string:
            name: DEPLOY_SCENARIO
            default: 'os-odl_l2-nofeature-ha'
        - string:
            name: GERRIT_REFSPEC_DEBUG
            default: 'false'
            description: "Gerrit refspec for debug."
        - string:
            name: SUITE_NAME
            default: '{suite}'
            description: "test suite name."
        - string:
            name: DOCKER_TAG
            default: '{docker-tag}'
            description: "docker image tag used for version control"

    scm:
        - git-scm

    builders:
        - 'bottlenecks-env-cleanup'
        - 'bottlenecks-run-suite'

    publishers:
        - email:
            recipients: hongbo.tianhongbo@huawei.com matthew.lijun@huawei.com liangqi1@huawei.com sunshine.wang@huawei.com

########################
# builder macros
########################
- builder:
    name: bottlenecks-env-cleanup
    builders:
        - shell: |
            #!/bin/bash
            set -e
            [[ $GERRIT_REFSPEC_DEBUG == true ]] && redirect="/dev/stdout" || redirect="/dev/null"

            BOTTLENECKS_IMAGE=opnfv/bottlenecks
            echo "Bottlenecks: docker containers/images cleaning up"

            dangling_images=($(docker images -f "dangling=true" | grep $BOTTLENECKS_IMAGE | awk '{print $3}'))
            if [[ -n $dangling_images ]]; then
                echo "Removing $BOTTLENECKS_IMAGE:<none> dangling images and their containers"
                docker images | head -1 && docker images | grep $dangling_images
                for image_id in "${dangling_images[@]}"; do
                    echo "Bottlenecks: Removing dangling image $image_id"
                    docker rmi -f $image_id >${redirect}
                done
            fi

            for image_id in "${dangling_images[@]}"; do
                if [[ -n $(docker ps -a | grep $image_id) ]]; then
                    echo "Bottlenecks: Removing containers associated with dangling image: $image_id"
                    docker ps -a | head -1 && docker ps -a | grep $image_id
                    docker ps -a | grep $image_id | awk '{print $1}'| xargs docker rm -f >${redirect}
                fi
            done

            if [[ -n $(docker ps -a | grep $BOTTLENECKS_IMAGE) ]]; then
                echo "Removing existing $BOTTLENECKS_IMAGE containers"
                docker ps -a | grep $BOTTLENECKS_IMAGE | awk '{print $1}' | xargs docker rm -f >$redirect
            fi

            if [[ -n $(docker images | grep $BOTTLENECKS_IMAGE) ]]; then
                echo "Bottlenecks: docker images to remove:"
                docker images | head -1 && docker images | grep $BOTTLENECKS_IMAGE
                image_tags=($(docker images | grep $BOTTLENECKS_IMAGE | awk '{print $2}'))
                for tag in "${image_tags[@]}"; do
                    echo "Removing docker image $BOTTLENECKS_IMAGE:$tag..."
                    docker rmi $BOTTLENECKS_IMAGE:$tag >$redirect
                done
            fi

            echo "Yardstick: docker containers/images cleaning up"
            YARDSTICK_IMAGE=opnfv/yardstick

            dangling_images=($(docker images -f "dangling=true" | grep $YARDSTICK_IMAGE | awk '{print $3}'))
            if [[ -n $dangling_images ]]; then
                echo "Removing $YARDSTICK_IMAGE:<none> dangling images and their containers"
                docker images | head -1 && docker images | grep $dangling_images
                for image_id in "${dangling_images[@]}"; do
                    echo "Yardstick: Removing dangling image $image_id"
                    docker rmi -f $image_id >${redirect}
                done
            fi

            for image_id in "${dangling_images[@]}"; do
                if [[ -n $(docker ps -a | grep $image_id) ]]; then
                    echo "Yardstick: Removing containers associated with dangling image: $image_id"
                    docker ps -a | head -1 && docker ps -a | grep $image_id
                    docker ps -a | grep $image_id | awk '{print $1}'| xargs docker rm -f >${redirect}
                fi
            done

            if [[ -n $(docker ps -a | grep $YARDSTICK_IMAGE) ]]; then
                echo "Removing existing $YARDSTICK_IMAGE containers"
                docker ps -a | grep $YARDSTICK_IMAGE | awk '{print $1}' | xargs docker rm -f >$redirect
            fi

            if [[ -n $(docker images | grep $YARDSTICK_IMAGE) ]]; then
                echo "Yardstick: docker images to remove:"
                docker images | head -1 && docker images | grep $YARDSTICK_IMAGE
                image_tags=($(docker images | grep $YARDSTICK_IMAGE | awk '{print $2}'))
                for tag in "${image_tags[@]}"; do
                    echo "Removing docker image $YARDSTICK_IMAGE:$tag..."
                    docker rmi $YARDSTICK_IMAGE:$tag >$redirect
                done
            fi

            echo "InfluxDB: docker containers/images cleaning up"
            INFLUXDB_IMAGE=tutum/influxdb

            dangling_images=($(docker images -f "dangling=true" | grep $INFLUXDB_IMAGE | awk '{print $3}'))
            if [[ -n $dangling_images ]]; then
                echo "Removing $INFLUXDB_IMAGE:<none> dangling images and their containers"
                docker images | head -1 && docker images | grep $dangling_images
                for image_id in "${dangling_images[@]}"; do
                    echo "InfluxDB: Removing dangling image $image_id"
                    docker rmi -f $image_id >${redirect}
                done
            fi

            for image_id in "${dangling_images[@]}"; do
                if [[ -n $(docker ps -a | grep $image_id) ]]; then
                    echo "InfluxDB: Removing containers associated with dangling image: $image_id"
                    docker ps -a | head -1 && docker ps -a | grep $image_id
                    docker ps -a | grep $image_id | awk '{print $1}'| xargs docker rm -f >${redirect}
                fi
            done

            if [[ -n $(docker ps -a | grep $INFLUXDB_IMAGE) ]]; then
                echo "Removing existing $INFLUXDB_IMAGE containers"
                docker ps -a | grep $INFLUXDB_IMAGE | awk '{print $1}' | xargs docker rm -f >$redirect
            fi

            if [[ -n $(docker images | grep $INFLUXDB_IMAGE) ]]; then
                echo "InfluxDB: docker images to remove:"
                docker images | head -1 && docker images | grep $INFLUXDB_IMAGE
                image_tags=($(docker images | grep $INFLUXDB_IMAGE | awk '{print $2}'))
                for tag in "${image_tags[@]}"; do
                    echo "Removing docker image $INFLUXDB_IMAGE:$tag..."
                    docker rmi $INFLUXDB_IMAGE:$tag >$redirect
                done
            fi

- builder:
    name: bottlenecks-run-suite
    builders:
        - shell: |
            #!/bin/bash
            set -e
            [[ $GERRIT_REFSPEC_DEBUG == true ]] && redirect="/dev/stdout" || redirect="/dev/null"
            BOTTLENECKS_IMAGE=opnfv/bottlenecks

            if [[ $SUITE_NAME == rubbos || $SUITE_NAME == vstf ]]; then
                echo "Bottlenecks: to pull image $BOTTLENECKS_IMAGE:${DOCKER_TAG}"
                docker pull $BOTTLENECKS_IMAGE:$DOCKER_TAG >${redirect}

                echo "Bottlenecks: docker start running"
                opts="--privileged=true -id"
                envs="-e INSTALLER_TYPE=${INSTALLER_TYPE} -e INSTALLER_IP=${INSTALLER_IP} \
                      -e NODE_NAME=${NODE_NAME} -e EXTERNAL_NET=${EXTERNAL_NETWORK} \
                      -e BOTTLENECKS_BRANCH=${BOTTLENECKS_BRANCH} -e GERRIT_REFSPEC_DEBUG=${GERRIT_REFSPEC_DEBUG} \
                      -e BOTTLENECKS_DB_TARGET=${BOTTLENECKS_DB_TARGET} -e PACKAGE_URL=${PACKAGE_URL}"
                cmd="sudo docker run ${opts} ${envs} $BOTTLENECKS_IMAGE:${DOCKER_TAG} /bin/bash"
                echo "Bottlenecks: docker cmd running ${cmd}"
                ${cmd} >${redirect}

                echo "Bottlenecks: obtain docker id"
                container_id=$(docker ps    | grep "$BOTTLENECKS_IMAGE:${DOCKER_TAG}" | awk '{print $1}' | head -1)
                if [ -z ${container_id} ]; then
                    echo "Cannot find $BOTTLENECKS_IMAGE container ID ${container_id}. Please check if it exists."
                    docker ps -a
                    exit 1
                fi

                echo "Bottlenecks: to prepare openstack environment"
                prepare_env="${REPO_DIR}/ci/prepare_env.sh"
                echo "Bottlenecks: docker cmd running: ${prepare_env}"
                sudo docker exec ${container_id} ${prepare_env}

                echo "Bottlenecks: to run testsuite ${SUITE_NAME}"
                run_testsuite="${REPO_DIR}/run_tests.sh -s ${SUITE_NAME}"
                echo "Bottlenecks: docker cmd running: ${run_testsuite}"
                sudo docker exec ${container_id} ${run_testsuite}
            elif [[ $SUITE_NAME == posca_stress_traffic ]]; then
                echo "Bottlenecks: installing docker-compose"
                if [ -d usr/local/bin/docker-compose ]; then
                    rm -rf usr/local/bin/docker-compose
                fi
                curl -L https://github.com/docker/compose/releases/download/1.11.0/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
                chmod +x /usr/local/bin/docker-compose

                echo "Bottlenecks: composing up dockers"
                cd $WORKSPACE
                docker-compose -f $WORKSPACE/docker/bottleneck-compose/docker-compose.yml up -d
                
                echo "Bottlenecks: pulling tutum/influxdb for yardstick"
                docker pull tutum/influxdb:0.13
                sleep 5

                echo "Bottlenecks: running traffic stress/factor testing in posca testsuite "
                docker exec bottleneckcompose_bottlenecks_1 bash /home/opnfv/bottlenecks/run_posca.sh

                echo "Bottlenecks: cleaning up docker-compose images and dockers"
                docker-compose -f $WORKSPACE/docker/bottleneck-compose/docker-compose.yml down --rmi all
            fi

####################
# parameter macros
####################

- parameter:
    name: 'bottlenecks-params-compass-baremetal'
    parameters:
        - string:
            name: BOTTLENECKS_DB_TARGET
            default: '104.197.68.199:8086'
            description: 'Arguments to use in order to choose the backend DB'

- parameter:
    name: 'bottlenecks-params-compass-virtual'
    parameters:
        - string:
            name: BOTTLENECKS_DB_TARGET
            default: ''
            description: 'Arguments to use in order to choose the backend DB'

- parameter:
    name: 'bottlenecks-params-orange-pod2'
    parameters:
        - string:
            name: BOTTLENECKS_DB_TARGET
            default: '104.197.68.199:8086'
            description: 'Arguments to use in order to choose the backend DB'

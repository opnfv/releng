#######################
# validate after MERGE
#######################
- project:
    name: qtip
    project: qtip

#--------------------------------
# BRANCH ANCHORS
#--------------------------------
    master: &master
        stream: master
        branch: '{stream}'
        gs-pathname: ''
        docker-tag: latest
    danube: &danube
        stream: danube
        branch: 'stable/{stream}'
        gs-pathname: '/{stream}'
        docker-tag: 'stable'

#--------------------------------
# JOB VARIABLES
#--------------------------------
    pod:
        - zte-pod1:
            installer: fuel
            <<: *master
        - zte-pod3:
            installer: fuel
            <<: *master
        - zte-pod1:
            installer: fuel
            <<: *danube
        - zte-pod3:
            installer: fuel
            <<: *danube
    task:
        - daily:
            auto-builder-name: qtip-validate-deploy
            auto-trigger-name: 'qtip-{pod}-daily-{stream}-trigger'
        - validate:
            auto-builder-name: qtip-validate-setup
            auto-trigger-name: gerrit-trigger-change-merged
        - experimental:
            auto-builder-name: qtip-validate-setup
            auto-trigger-name: experimental

#--------------------------------
# JOB LIST
#--------------------------------
    jobs:
        - 'qtip-{task}-{installer}-{pod}-{stream}'

################################
# job templates
################################
- job-template:
    name: 'qtip-{task}-{installer}-{pod}-{stream}'
    disabled: false
    parameters:
        - project-parameter:
            project: '{project}'
            branch: '{branch}'
        - '{installer}-defaults'
        - '{pod}-defaults'
        - string:
            name: DEPLOY_SCENARIO
            default: 'os-nosdn-nofeature-ha'
        - string:
            name: DOCKER_TAG
            default: '{docker-tag}'
            description: 'Tag to pull docker image'
        - string:
            name: CI_DEBUG
            default: 'false'
            description: "Show debug output information"
    scm:
        - git-scm
    triggers:
        - '{auto-trigger-name}'
    builders:
        - qtip-common-builders
        - '{auto-builder-name}'
    publishers:
        - qtip-common-publishers

################
# MARCOS
################

#---------
# builder
#---------
- builder:
    name: qtip-common-builders
    builders:
        - description-setter:
            description: "POD: $NODE_NAME"

- builder:
    name: qtip-validate-deploy
    builders:
        - shell:
            !include-raw: ./helpers/validate-deploy.sh
        - shell:
            !include-raw: ./helpers/cleanup-deploy.sh

- builder:
    name: qtip-validate-setup
    builders:
        - shell:
            !include-raw: ./helpers/validate-setup.sh

#-----------
# parameter
#-----------

#-----------
# publisher
#-----------

- publisher:
    name: qtip-common-publishers
    publishers:
        - email:
            recipients: wu.zhihui1@zte.com.cn, zhang.yujunz@zte.com.cn

#---------
# trigger
#---------

- trigger:
    name: 'qtip-zte-pod1-daily-master-trigger'
    triggers:
        - timed: '30 0 * * *'

- trigger:
    name: 'qtip-zte-pod3-daily-master-trigger'
    triggers:
        - timed: '30 0 * * *'

- trigger:
    name: 'qtip-zte-pod1-daily-danube-trigger'
    triggers:
        - timed: '0 7 * * *'

- trigger:
    name: 'qtip-zte-pod3-daily-danube-trigger'
    triggers:
        - timed: '0 7 * * *'

- trigger:
    name: qtip-validate-trigger
    triggers:
        - gerrit-trigger-change-merged:
            project: '{project}'
            branch: '{branch}'
            files: '**'

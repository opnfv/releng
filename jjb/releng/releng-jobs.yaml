---
- scm:
    name: releng-scm
    scm:
      - git:
          url: 'https://gerrit.opnfv.org/gerrit/releng'
          refspec: '+refs/heads/*:refs/remotes/origin/* +refs/changes/*:refs/changes/*'
          submodule:
            recursive: true
          branches:
            - '{ref}'

- trigger:
    name: releng-patchset-created
    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
            - comment-added-contains-event:
                comment-contains-value: 'recheck'
            - comment-added-contains-event:
                comment-contains-value: 'reverify'
          projects:
            - project-compare-type: 'ANT'
              project-pattern: 'releng'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern: 'master'

- trigger:
    name: releng-patchset-merged
    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
            - comment-added-contains-event:
                comment-contains-value: 'remerge'
          projects:
            - project-compare-type: 'ANT'
              project-pattern: 'releng'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern: 'master'

- builder:
    name: releng-jjb-verify
    builders:
      - shell: |
          sudo apt-get -o DPkg::Lock::Timeout=300 update && \
          sudo DEBIAN_FRONTEND=noninteractive apt-get \
            -o DPkg::Lock::Timeout=300 dist-upgrade -y
          sudo DEBIAN_FRONTEND=noninteractive \
          apt-get -o DPkg::Lock::Timeout=300 install jenkins-job-builder -y
          jenkins-jobs test --recursive -o tmp jjb/
          rm -rf tmp

- builder:
    name: releng-jjb-merge
    builders:
      - shell: |
          sudo apt-get -o DPkg::Lock::Timeout=300 update && \
          sudo DEBIAN_FRONTEND=noninteractive apt-get \
            -o DPkg::Lock::Timeout=300 dist-upgrade -y
          sudo DEBIAN_FRONTEND=noninteractive \
          apt-get -o DPkg::Lock::Timeout=300 install jenkins-job-builder -y
          jenkins-jobs update --recursive --delete-old jjb/

- parameter:
    name: releng-jjb-slave
    parameters:
      - label:
          name: slave
          default: '{slave}'

- job-template:
    name: releng-jjb-verify
    triggers:
      - releng-patchset-created
    scm:
      - releng-scm:
          ref: $GERRIT_REFSPEC
    parameters:
      - releng-jjb-slave:
          slave: opnfv-build
    builders:
      - releng-jjb-verify

- project:
    name: releng-jjb-verify
    jobs:
      - releng-jjb-verify

- job-template:
    name: releng-jjb-merge
    triggers:
      - releng-patchset-merged
    scm:
      - releng-scm:
          ref: master
    parameters:
      - releng-jjb-slave:
          slave: opnfv-build
    builders:
      - releng-jjb-merge

- project:
    name: releng-jjb-merge
    jobs:
      - releng-jjb-merge

- scm:
    name: opnfv-scm
    scm:
      - git:
          url: 'https://gerrit.opnfv.org/gerrit/{project}'
          refspec: '+refs/heads/*:refs/remotes/origin/* +refs/changes/*:refs/changes/*'
          submodule:
            recursive: true
          branches:
            - '{ref}'

- trigger:
    name: tox-patchset-created
    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
            - comment-added-contains-event:
                comment-contains-value: recheck
            - comment-added-contains-event:
                comment-contains-value: reverify
          projects:
            - project-compare-type: 'REG_EXP'
              project-pattern: '^(?!functest).*'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern:
                    - master
                    - stable/nile
                    - stable/moselle

- builder:
    name: tox
    builders:
      - shell: |
          [ -f tox.ini ] || true
          sudo apt-get -o DPkg::Lock::Timeout=300 update && \
          sudo DEBIAN_FRONTEND=noninteractive apt-get \
            -o DPkg::Lock::Timeout=300 dist-upgrade -y
          sudo DEBIAN_FRONTEND=noninteractive \
          apt-get -o DPkg::Lock::Timeout=300 install tox -y
          tox

- parameter:
    name: tox-slave
    parameters:
      - label:
          name: slave
          default: '{slave}'

- job-template:
    name: releng-tox
    triggers:
      - tox-patchset-created
    scm:
      - opnfv-scm:
          ref: $GERRIT_REFSPEC
          project: $GERRIT_PROJECT
    parameters:
      - tox-slave:
          slave: opnfv-build
    builders:
      - tox

- project:
    name: releng-tox
    jobs:
      - releng-tox

---
- scm:
    name: releng-scm
    scm:
      - git:
          url: 'ssh://jenkins-ci@gerrit.opnfv.org:29418/releng'
          refspec: '+refs/heads/*:refs/remotes/origin/* +refs/changes/*:refs/changes/*'
          submodule:
            recursive: true
          branches:
            - '{ref}'

- trigger:
    name: releng-patchset-created
    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
            - comment-added-contains-event:
                comment-contains-value: 'recheck'
            - comment-added-contains-event:
                comment-contains-value: 'reverify'
          projects:
            - project-compare-type: 'ANT'
              project-pattern: 'releng'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern: 'master'

- trigger:
    name: releng-patchset-merged
    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
            - comment-added-contains-event:
                comment-contains-value: 'remerge'
          projects:
            - project-compare-type: 'ANT'
              project-pattern: 'releng'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern: 'master'

- builder:
    name: releng-jjb-verify
    builders:
      - shell: |
          sudo apt-get -o DPkg::Lock::Timeout=300 update && \
          sudo DEBIAN_FRONTEND=noninteractive apt-get \
            -o DPkg::Lock::Timeout=300 dist-upgrade -y
          sudo DEBIAN_FRONTEND=noninteractive \
          apt-get -o DPkg::Lock::Timeout=300 install jenkins-job-builder -y
          jenkins-jobs test --recursive -o tmp jjb/
          rm -rf tmp

- builder:
    name: releng-jjb-merge
    builders:
      - shell: |
          sudo apt-get -o DPkg::Lock::Timeout=300 update && \
          sudo DEBIAN_FRONTEND=noninteractive apt-get \
            -o DPkg::Lock::Timeout=300 dist-upgrade -y
          sudo DEBIAN_FRONTEND=noninteractive \
          apt-get -o DPkg::Lock::Timeout=300 install jenkins-job-builder -y
          jenkins-jobs update --recursive --delete-old jjb/

- parameter:
    name: releng-jjb-node
    parameters:
      - label:
          name: node
          default: '{node}'

- job-template:
    name: releng-jjb-verify
    triggers:
      - releng-patchset-created
    scm:
      - releng-scm:
          ref: $GERRIT_REFSPEC
    parameters:
      - releng-jjb-node:
          node: opnfv-build
    builders:
      - releng-jjb-verify

- project:
    name: releng-jjb-verify
    jobs:
      - releng-jjb-verify

- job-template:
    name: releng-jjb-merge
    triggers:
      - releng-patchset-merged
    scm:
      - releng-scm:
          ref: master
    parameters:
      - releng-jjb-node:
          node: opnfv-build
    builders:
      - releng-jjb-merge

- project:
    name: releng-jjb-merge
    jobs:
      - releng-jjb-merge

- scm:
    name: opnfv-scm
    scm:
      - git:
          url: 'https://gerrit.opnfv.org/gerrit/{project}'
          refspec: '+refs/heads/*:refs/remotes/origin/* +refs/changes/*:refs/changes/*'
          submodule:
            recursive: true
          branches:
            - '{ref}'

- trigger:
    name: releng-tox-patchset-created
    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
            - comment-added-contains-event:
                comment-contains-value: recheck
            - comment-added-contains-event:
                comment-contains-value: reverify
          server-name: gerrit.opnfv.org
          projects:
            - project-compare-type: 'REG_EXP'
              project-pattern: '^(?!functest).*'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern: master
                - branch-compare-type: 'ANT'
                  branch-pattern: stable/nile
                - branch-compare-type: 'ANT'
                  branch-pattern: stable/moselle

- builder:
    name: releng-tox
    builders:
      - shell: |
          [ -f tox.ini ] || exit 0
          sudo apt-get -o DPkg::Lock::Timeout=300 update && \
          sudo DEBIAN_FRONTEND=noninteractive apt-get \
            -o DPkg::Lock::Timeout=300 dist-upgrade -y
          sudo DEBIAN_FRONTEND=noninteractive \
          apt-get -o DPkg::Lock::Timeout=300 install tox -y
          tox --recreate

- parameter:
    name: releng-tox-node
    parameters:
      - label:
          name: node
          default: '{node}'

- job-template:
    name: releng-tox
    triggers:
      - releng-tox-patchset-created
    scm:
      - opnfv-scm:
          ref: $GERRIT_REFSPEC
          project: $GERRIT_PROJECT
    parameters:
      - releng-tox-node:
          node: opnfv-build
    builders:
      - releng-tox

- project:
    name: releng-tox
    jobs:
      - releng-tox

- project:
    name: releng-release-jobs
    stream:
      - nile
      - v1.22
      - v1.23
      - v1.24
      - v1.25
      - xena
      - wallaby
      - yoga
      - zed
    jobs:
      - 'releng-release-{stream}-verify'
      - 'releng-release-{stream}-merge'

- parameter:
    name: stream-parameter
    parameters:
      - string:
          name: STREAM
          default: '{stream}'

- job-template:
    name: 'releng-release-{stream}-verify'
    scm:
      - releng-scm:
          ref: $GERRIT_REFSPEC
    parameters:
      - releng-jjb-node:
          node: opnfv-build
      - stream-parameter:
          stream: '{stream}'
    triggers:
      - gerrit:
          server-name: 'gerrit.opnfv.org'
          trigger-on:
            - patchset-created-event:
                exclude-drafts: 'false'
                exclude-trivial-rebase: 'false'
                exclude-no-code-change: 'false'
            - comment-added-contains-event:
                comment-contains-value: 'recheck'
            - comment-added-contains-event:
                comment-contains-value: 'reverify'
          projects:
            - project-compare-type: 'ANT'
              project-pattern: 'releng'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern: '**/master'
              file-paths:
                - compare-type: ANT
                  pattern: 'releases/{stream}/**'
                - compare-type: ANT
                  pattern: 'releases/schema.yaml'
                - compare-type: ANT
                  pattern: 'releases/scripts/verify_schema.py'
    builders:
      - shell: |
          sudo apt-get -o DPkg::Lock::Timeout=300 update && \
          sudo DEBIAN_FRONTEND=noninteractive apt-get \
            -o DPkg::Lock::Timeout=300 dist-upgrade -y
          sudo DEBIAN_FRONTEND=noninteractive \
          apt-get -o DPkg::Lock::Timeout=300 install python3-pygerrit2 \
            python3-ruamel.yaml  -y
      - shell: !include-raw-escape:
          - branch-or-tag.sh

- job-template:
    name: 'releng-release-{stream}-merge'
    triggers:
      - releng-patchset-merged
    scm:
      - releng-scm:
          ref: $GERRIT_REFSPEC
    parameters:
      - releng-jjb-node:
          node: opnfv-build
      - stream-parameter:
          stream: '{stream}'
      - string:
          name: GIT_URL
          default: ssh://$USER@gerrit.opnfv.org:29418/
    triggers:
      - gerrit:
          trigger-on:
            - change-merged-event
            - comment-added-contains-event:
                comment-contains-value: 'remerge'
          projects:
            - project-compare-type: 'ANT'
              project-pattern: 'releng'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern: 'master'
              file-paths:
                - compare-type: ANT
                  pattern: 'releases/{stream}/**'
    builders:
      - shell: |
          sudo apt-get -o DPkg::Lock::Timeout=300 update && \
          sudo DEBIAN_FRONTEND=noninteractive apt-get \
            -o DPkg::Lock::Timeout=300 dist-upgrade -y
          sudo DEBIAN_FRONTEND=noninteractive \
          apt-get -o DPkg::Lock::Timeout=300 install python3-pygerrit2 \
            python3-ruamel.yaml  -y
      - shell: !include-raw-escape:
          - branch-or-tag.sh

---
- scm:
    name: releng-scm
    scm:
      - git:
          url: 'https://gerrit.opnfv.org/gerrit/releng'
          refspec: '+refs/heads/*:refs/remotes/origin/* +refs/changes/*:refs/changes/*'
          branches:
            - '{ref}'

- trigger:
    name: releng-patchset-created
    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
            - comment-added-contains-event:
                comment-contains-value: 'recheck'
            - comment-added-contains-event:
                comment-contains-value: 'reverify'
          projects:
            - project-compare-type: 'ANT'
              project-pattern: 'releng'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern: 'master'

- builder:
    name: jjb-verify
    builders:
      - shell: |
          sudo apt-get -o DPkg::Lock::Timeout=300 update && \
          sudo DEBIAN_FRONTEND=noninteractive apt-get \
            -o DPkg::Lock::Timeout=300 dist-upgrade -y
          sudo DEBIAN_FRONTEND=noninteractive \
          apt-get -o DPkg::Lock::Timeout=300 install jenkins-job-builder -y
          jenkins-jobs test --recursive -o /dev/null jjb/

- parameter:
    name: jjb-slave
    parameters:
      - label:
          name: slave
          default: '{slave}'

- job-template:
    name: jjb-verify
    triggers:
      - releng-patchset-created
    scm:
      - releng-scm:
          ref: $GERRIT_REFSPEC
    parameters:
      - jjb-slave:
          slave: lf-virtual1
    builders:
      - jjb-verify

- project:
    name: 'jjb-verify'
    jobs:
      - 'jjb-verify'


- project:
    name: releng-builder-jobs
    project: 'releng'
    project-name: 'releng'
    jjb-version: '2.5.0'
    jjb-cache: "$WORKSPACE/.cache/jenkins_jobs"

    build-timeout: 60

    rtd-build-url: 'https://readthedocs.org/api/v2/webhook/opnfv-releng/38594/'
    rtd-token: '291c6a0109493b4457e566d06141212452c65784'
    project-pattern: 'releng'

    jobs:
      - '{project-name}-ci-jobs'
      - '{project-name}-rtd-jobs'

- project:
    name: 'opnfv-xci-verify'

    project: releng-xci
#--------------------------------
# branches
#--------------------------------
    stream:
        - master:
            branch: '{stream}'
#--------------------------------
# distros
#--------------------------------
    distro:
        - 'ubuntu':
            disabled: false
        - 'centos':
            disabled: true
        - 'opensuse':
            disabled: true
#--------------------------------
# type
#--------------------------------
    type:
        - virtual
#--------------------------------
# patch verification phases
#--------------------------------
    phase:
        - 'deploy'
        - 'healthcheck'
#--------------------------------
# jobs
#--------------------------------
    jobs:
        - 'xci-verify-{distro}-{type}-{stream}'
        - 'xci-verify-{phase}-{type}-{stream}'
#--------------------------------
# job templates
#--------------------------------
- job-template:
    name: 'xci-verify-{distro}-{type}-{stream}'

    project-type: multijob

    disabled: '{obj:disabled}'

    concurrent: true

    properties:
        - logrotate-default
        - build-blocker:
            use-build-blocker: true
            blocking-jobs:
                - 'xci-verify-.*'
                - 'bifrost-verify-.*'
                - 'bifrost-periodic-.*'
                - 'osa-verify-.*'
                - 'osa-periodic-.*'
            block-level: 'NODE'

    wrappers:
        - ssh-agent-wrapper
        - build-timeout:
            timeout: 240
        - fix-workspace-permissions

    scm:
        - git-scm-gerrit

    triggers:
        - gerrit:
            server-name: 'gerrit.opnfv.org'
            trigger-on:
                - patchset-created-event:
                    exclude-drafts: 'false'
                    exclude-trivial-rebase: 'false'
                    exclude-no-code-change: 'true'
                - draft-published-event
                - comment-added-contains-event:
                    comment-contains-value: 'recheck'
                - comment-added-contains-event:
                    comment-contains-value: 'reverify'
            projects:
              - project-compare-type: 'ANT'
                project-pattern: '{project}'
                branches:
                  - branch-compare-type: 'ANT'
                    branch-pattern: '**/{branch}'
                disable-strict-forbidden-file-verification: 'true'
                file-paths:
                  - compare-type: ANT
                    pattern: 'bifrost/**'
                  - compare-type: ANT
                    pattern: 'xci/**'
                forbidden-file-paths:
                  - compare-type: ANT
                    pattern: 'prototypes/**'
                  - compare-type: ANT
                    pattern: 'upstream/**'
                  - compare-type: ANT
                    pattern: '**/README.rst'
                  - compare-type: ANT
                    pattern: 'docs/**'
            readable-message: true

    parameters:
        - project-parameter:
            project: '{project}'
            branch: '{branch}'
        - label:
            name: SLAVE_LABEL
            default: 'xci-virtual-{distro}'
        - string:
            name: CLEAN_DIB_IMAGES
            default: 'true'
        - string:
            name: GIT_BASE
            default: https://gerrit.opnfv.org/gerrit/$PROJECT
            description: 'Git URL to use on this Jenkins Slave'

    builders:
        - description-setter:
            description: "Built on $NODE_NAME"
        - multijob:
            name: deploy
            condition: SUCCESSFUL
            projects:
                - name: 'xci-verify-deploy-{type}-{stream}'
                  current-parameters: true
                  predefined-parameters: |
                    DISTRO={distro}
                    DEPLOY_SCENARIO=os-nosdn-nofeature-noha
                    CLEAN_DIB_IMAGES=$CLEAN_DIB_IMAGES
                  node-parameters: true
                  kill-phase-on: FAILURE
                  abort-all-job: true
        - multijob:
            name: healthcheck
            condition: SUCCESSFUL
            projects:
                - name: 'xci-verify-healthcheck-{type}-{stream}'
                  current-parameters: true
                  predefined-parameters: |
                    DISTRO={distro}
                    DEPLOY_SCENARIO=os-nosdn-nofeature-noha
                    CLEAN_DIB_IMAGES=$CLEAN_DIB_IMAGES
                    FUNCTEST_MODE=tier
                    FUNCTEST_TIER=healthcheck
                  node-parameters: true
                  kill-phase-on: NEVER
                  abort-all-job: true

- job-template:
    name: 'xci-verify-{phase}-{type}-{stream}'

    disabled: false

    concurrent: true

    properties:
        - logrotate-default
        - build-blocker:
            use-build-blocker: true
            blocking-jobs:
                - 'xci-verify-deploy-.*'
                - 'xci-verify-healthcheck-.*'
                - 'bifrost-verify-.*'
                - 'bifrost-periodic-.*'
                - 'osa-verify-.*'
                - 'osa-periodic-.*'
            block-level: 'NODE'

    parameters:
        - string:
            name: DISTRO
            default: 'xenial'
        - string:
            name: DEPLOY_SCENARIO
            default: 'os-nosdn-nofeature-noha'
        - string:
            name: FUNCTEST_MODE
            default: 'tier'
        - string:
            name: FUNCTEST_SUITE_NAME
            default: 'healthcheck'
        - string:
            name: XCI_FLAVOR
            default: 'mini'
        - string:
            name: CLEAN_DIB_IMAGES
            default: 'true'
        - string:
            name: OPNFV_RELENG_DEV_PATH
            default: $WORKSPACE/
        - string:
            name: INSTALLER_TYPE
            default: 'osa'
        - string:
            name: GIT_BASE
            default: https://gerrit.opnfv.org/gerrit/$PROJECT
            description: 'Git URL to use on this Jenkins Slave'

    wrappers:
        - ssh-agent-wrapper
        - build-timeout:
            timeout: 240
        - fix-workspace-permissions

    scm:
        - git-scm-gerrit

    builders:
        - description-setter:
            description: "Built on $NODE_NAME"
        - 'xci-verify-new-vm-macro'
        - 'xci-verify-{phase}-macro'
        - 'xci-verify-destroy-vm-macro'

#--------------------------------
# builder macros
#--------------------------------
- builder:
    name: 'xci-verify-new-vm-macro'
    builders:
        - shell: |
            #!/bin/bash

            # skip the deployment if the patch doesn't impact the deployment
            if [[ "$GERRIT_TOPIC" =~ 'skip-verify' ]]; then
                echo "Skipping the deployment!"
                exit 0
            fi

            cd $WORKSPACE
            ./xci/scripts/vm/start-new-vm.sh $DISTRO

- builder:
    name: 'xci-verify-deploy-macro'
    builders:
        - shell: |
            #!/bin/bash

            # skip the deployment if the patch doesn't impact the deployment
            if [[ "$GERRIT_TOPIC" =~ 'skip-verify' ]]; then
                echo "Skipping the deployment!"
                exit 0
            fi

            ssh ${DISTRO}_xci_vm "cd releng-xci/xci && ./xci-deploy.sh"

- builder:
    name: 'xci-verify-destroy-vm-macro'
    builders:
        - shell: |
            #!/bin/bash

            # skip the deployment if the patch doesn't impact the deployment
            if [[ "$GERRIT_TOPIC" =~ 'skip-verify' ]]; then
                echo "Skipping the deployment!"
                exit 0
            fi

            sudo virsh destroy $DISTRO
            sudo virsh undefine $DISTRO

- builder:
    name: 'xci-verify-healthcheck-macro'
    builders:
        - shell: |
            #!/bin/bash

            # skip the healthcheck if the patch doesn't impact the deployment
            if [[ "$GERRIT_TOPIC" =~ 'skip-verify' ]]; then
                echo "Skipping the healthcheck!"
                exit 0
            fi

            echo "Hello World!"

# this will be enabled once the xci is prepared
#- builder:
#    name: 'xci-verify-healthcheck-macro'
#    builders:
#        - shell:
#            !include-raw: ../../utils/fetch_os_creds.sh
#        - shell:
#            !include-raw: ../functest/functest-alpine.sh

---
- functest-pi-containers: &functest-pi-containers
    name: 'functest-pi-containers'
    repo: '{repo}'
    port: '{port}'
    container: '{container}'
    tag: '{tag}'

- functest-pi-params: &functest-pi-params
    name: 'functest-pi-params'
    tag:
      - latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena-latest:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm64-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm64-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm64-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - arm64-xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm64-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91

- functest-pi-ollivier-functest-healthcheck-params: &functest-pi-ollivier-functest-healthcheck-params
    name: 'functest-pi-ollivier-functest-healthcheck-params'
    repo: 'ollivier'
    container: 'functest-healthcheck'
    port:
    tag:
      - latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena-latest:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm64-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm64-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm64-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - arm64-xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm64-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91

- functest-pi-ollivier-functest-smoke-params: &functest-pi-ollivier-functest-smoke-params
    name: 'functest-pi-ollivier-functest-smoke-params'
    repo: 'ollivier'
    container: 'functest-smoke'
    port:
    tag:
      - latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena-latest:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm64-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm64-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm64-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - arm64-xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm64-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91

- functest-pi-ollivier-functest-smoke-cntt-params: &functest-pi-ollivier-functest-smoke-cntt-params
    name: 'functest-pi-ollivier-functest-smoke-cntt-params'
    repo: 'ollivier'
    container: 'functest-smoke-cntt'
    port:
    tag:
      - latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena-latest:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm64-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm64-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm64-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - arm64-xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm64-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91

- functest-pi-ollivier-functest-benchmarking-params: &functest-pi-ollivier-functest-benchmarking-params
    name: 'functest-pi-ollivier-functest-benchmarking-params'
    repo: 'ollivier'
    container: 'functest-benchmarking'
    port:
    tag:
      - latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena-latest:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm64-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm64-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm64-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - arm64-xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm64-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91

- functest-pi-ollivier-functest-benchmarking-cntt-params: &functest-pi-ollivier-functest-benchmarking-cntt-params
    name: 'functest-pi-ollivier-functest-benchmarking-cntt-params'
    repo: 'ollivier'
    container: 'functest-benchmarking-cntt'
    port:
    tag:
      - latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena-latest:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm64-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm64-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm64-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - arm64-xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm64-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91

- functest-pi-ollivier-functest-vnf-params: &functest-pi-ollivier-functest-vnf-params
    name: 'functest-pi-ollivier-functest-vnf-params'
    repo: 'ollivier'
    container: 'functest-vnf'
    port:
    tag:
      - latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - xena-latest:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91
      - arm64-latest:
          node: lf-pod4
          DASHBOARD_URL: http://172.30.12.83
      - arm64-zed:
          node: lf-virtual9
          DASHBOARD_URL: http://172.30.13.94
      - arm64-yoga:
          node: lf-pod4-3
          DASHBOARD_URL: http://172.30.12.88
      - arm64-xena:
          node: laas-xena
          DASHBOARD_URL: http://10.200.120.76
      - arm64-wallaby:
          node: lf-virtual6
          DASHBOARD_URL: http://172.30.13.91

- functest-pi-jobs: &functest-pi-jobs
    name: 'functest-pi-jobs'
    current-parameters: true

- parameter:
    name: functest-pi-node
    parameters:
      - label:
          name: node
          default: '{node}'

- parameter:
    name: functest-pi-build_tag
    parameters:
      - random-string:
          name: build_tag

- parameter:
    name: functest-pi-EXTERNAL_NETWORK
    parameters:
      - string:
          name: EXTERNAL_NETWORK
          default: public

- parameter:
    name: functest-pi-VOLUME_DEVICE_NAME
    parameters:
      - string:
          name: VOLUME_DEVICE_NAME
          default: sdb

- parameter:
    name: functest-pi-IMAGE_PROPERTIES
    parameters:
      - string:
          name: IMAGE_PROPERTIES
          default: hw_scsi_model:virtio-scsi,hw_disk_bus:scsi

- functest-pi-run-containers: &functest-pi-run-containers
    name: 'functest-pi-run-containers'
    <<: *functest-pi-containers
    privileged: '{privileged}'
    volumes: '{volumes}'
    env: '{env}'
    network: '{network}'
    uid: '{uid}'
    gid: '{gid}'
    published_ports: '{published_ports}'
    DASHBOARD_URL: '{DASHBOARD_URL}'

- builder:
    name: functest-pi-pull-containers
    builders:
      - shell: |
          set +x
          if [ "{repo}" = "_" ]; then
            image={container}:{tag}
          elif [ "{port}" = "None" ]; then
            image={repo}/{container}:{tag}
          else
            image={repo}:{port}/{container}:{tag}
          fi
          sudo docker pull $image

- builder:
    name: functest-pi-run-containers
    builders:
      - shell: |
          set +x
          volumes=;
          if [ "{volumes}" != "None" ]; then
            for i in $(echo {volumes} | tr -d '[]' |sed "s/, / /g" ); \
              do volumes="-v $i $volumes"; done
          fi
          env=;
          if [ "{env}" != "None" ]; then
            for i in $(eval echo {env} | tr -d '[]' |sed "s/, / /g" ); \
              do env="-e $i $env"; done
          fi
          published_ports=;
          if [ "{published_ports}" != "None" ]; then
            for i in $(echo {published_ports} | tr -d '[]' |sed "s/, / /g" ); \
              do published_ports="-p $i $published_ports"; done
          fi
          [ ! -z "$WORKSPACE" ] && sudo rm -rf $WORKSPACE/results || true
          if [ "{repo}" = "_" ]; then
            image={container}:{tag}
          elif [ "{port}" = "None" ]; then
            image={repo}/{container}:{tag}
          else
            image={repo}:{port}/{container}:{tag}
          fi
          sudo mkdir -p $WORKSPACE/results
          sudo chown {uid}:{gid} $WORKSPACE/results
          sudo docker run --rm \
            --privileged={privileged} \
            --network={network} \
            $volumes \
            $env \
            $published_ports \
            -e S3_ENDPOINT_URL=https://storage.googleapis.com \
            -e S3_DST_URL=s3://artifacts.opnfv.org/functest/$BUILD_TAG/$JOB_NAME-$BUILD_ID \
            -e HTTP_DST_URL=http://artifacts.opnfv.org/functest/$BUILD_TAG/$JOB_NAME-$BUILD_ID \
            -v /home/opnfv/functest/.boto:/etc/boto.cfg \
            -e TEST_DB_URL=http://testresults.opnfv.org/test/api/v1/results \
            -e TEST_DB_EXT_URL=http://testresults.opnfv.org/test/api/v1/results \
            -e NODE_NAME=$node \
            -e BUILD_TAG=$BUILD_TAG \
            -v $WORKSPACE/../$JOB_NAME/results:/var/lib/xtesting/results \
            -e DASHBOARD_URL={DASHBOARD_URL} \
            $image run_tests -t {test} -p -r

- builder:
    name: functest-pi-remove-images
    builders:
      - shell: |
          set +x
          if [ "{repo}" = "_" ]; then
            image={container}:{tag}
          elif [ "{port}" = "None" ]; then
            image={repo}/{container}:{tag}
          else
            image={repo}:{port}/{container}:{tag}
          fi
          sudo docker rmi $image || true

- job-template:
    name: 'functest-pi-ollivier-functest-healthcheck-{tag}-pull'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-pull-containers:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-healthcheck-pull'
    <<: *functest-pi-ollivier-functest-healthcheck-params
    jobs:
      - 'functest-pi-ollivier-functest-healthcheck-{tag}-pull'

- job-template:
    name: 'functest-pi-ollivier-functest-healthcheck-{tag}-rmi'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-remove-images:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-healthcheck-rmi'
    <<: *functest-pi-ollivier-functest-healthcheck-params
    jobs:
      - 'functest-pi-ollivier-functest-healthcheck-{tag}-rmi'

- job-template:
    name: 'functest-pi-ollivier-functest-smoke-{tag}-pull'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-pull-containers:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-smoke-pull'
    <<: *functest-pi-ollivier-functest-smoke-params
    jobs:
      - 'functest-pi-ollivier-functest-smoke-{tag}-pull'

- job-template:
    name: 'functest-pi-ollivier-functest-smoke-{tag}-rmi'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-remove-images:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-smoke-rmi'
    <<: *functest-pi-ollivier-functest-smoke-params
    jobs:
      - 'functest-pi-ollivier-functest-smoke-{tag}-rmi'

- job-template:
    name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-pull'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-pull-containers:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-smoke-cntt-pull'
    <<: *functest-pi-ollivier-functest-smoke-cntt-params
    jobs:
      - 'functest-pi-ollivier-functest-smoke-cntt-{tag}-pull'

- job-template:
    name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-rmi'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-remove-images:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-smoke-cntt-rmi'
    <<: *functest-pi-ollivier-functest-smoke-cntt-params
    jobs:
      - 'functest-pi-ollivier-functest-smoke-cntt-{tag}-rmi'

- job-template:
    name: 'functest-pi-ollivier-functest-benchmarking-{tag}-pull'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-pull-containers:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-benchmarking-pull'
    <<: *functest-pi-ollivier-functest-benchmarking-params
    jobs:
      - 'functest-pi-ollivier-functest-benchmarking-{tag}-pull'

- job-template:
    name: 'functest-pi-ollivier-functest-benchmarking-{tag}-rmi'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-remove-images:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-benchmarking-rmi'
    <<: *functest-pi-ollivier-functest-benchmarking-params
    jobs:
      - 'functest-pi-ollivier-functest-benchmarking-{tag}-rmi'

- job-template:
    name: 'functest-pi-ollivier-functest-benchmarking-cntt-{tag}-pull'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-pull-containers:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-benchmarking-cntt-pull'
    <<: *functest-pi-ollivier-functest-benchmarking-cntt-params
    jobs:
      - 'functest-pi-ollivier-functest-benchmarking-cntt-{tag}-pull'

- job-template:
    name: 'functest-pi-ollivier-functest-benchmarking-cntt-{tag}-rmi'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-remove-images:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-benchmarking-cntt-rmi'
    <<: *functest-pi-ollivier-functest-benchmarking-cntt-params
    jobs:
      - 'functest-pi-ollivier-functest-benchmarking-cntt-{tag}-rmi'

- job-template:
    name: 'functest-pi-ollivier-functest-vnf-{tag}-pull'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-pull-containers:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-vnf-pull'
    <<: *functest-pi-ollivier-functest-vnf-params
    jobs:
      - 'functest-pi-ollivier-functest-vnf-{tag}-pull'

- job-template:
    name: 'functest-pi-ollivier-functest-vnf-{tag}-rmi'
    parameters:
      - functest-pi-node:
          node: '{node}'
    builders:
      - functest-pi-remove-images:
          <<: *functest-pi-containers

- project:
    name: 'functest-pi-ollivier-functest-vnf-rmi'
    <<: *functest-pi-ollivier-functest-vnf-params
    jobs:
      - 'functest-pi-ollivier-functest-vnf-{tag}-rmi'

- job-template:
    name: 'functest-pi-ollivier-functest-healthcheck-{tag}-{test}-run'
    parameters:
      - functest-pi-node:
          node: '{node}'
      - functest-pi-build_tag:
          build_tag: ''
      - functest-pi-EXTERNAL_NETWORK:
          EXTERNAL_NETWORK: public
      - functest-pi-VOLUME_DEVICE_NAME:
          VOLUME_DEVICE_NAME: sdb
      - functest-pi-IMAGE_PROPERTIES:
          IMAGE_PROPERTIES: hw_scsi_model:virtio-scsi,hw_disk_bus:scsi
    builders:
      - functest-pi-run-containers:
          <<: *functest-pi-run-containers
          test: '{test}'

- project:
    name: 'functest-pi-ollivier-functest-healthcheck'
    <<: *functest-pi-ollivier-functest-healthcheck-params
    volumes:
      - /home/opnfv/functest/openstack.creds:/home/opnfv/functest/conf/env_file
      - /home/opnfv/functest/images:/home/opnfv/functest/images
    env:
      - EXTERNAL_NETWORK=$EXTERNAL_NETWORK
      - VOLUME_DEVICE_NAME=$VOLUME_DEVICE_NAME
      - IMAGE_PROPERTIES=$IMAGE_PROPERTIES
    published_ports:
    container: 'functest-healthcheck'
    test:
      - connection_check
      - tenantnetwork1
      - tenantnetwork2
      - vmready1
      - vmready2
      - singlevm1
      - singlevm2
      - vping_ssh
      - vping_userdata
      - cinder_test
      - odl
      - tempest_smoke
      - tempest_horizon
    privileged: 'false'
    network: bridge
    uid: 1000
    gid: 1000
    jobs:
      - 'functest-pi-ollivier-functest-healthcheck-{tag}-{test}-run'

- job-template:
    name: 'functest-pi-ollivier-functest-smoke-{tag}-{test}-run'
    parameters:
      - functest-pi-node:
          node: '{node}'
      - functest-pi-build_tag:
          build_tag: ''
      - functest-pi-EXTERNAL_NETWORK:
          EXTERNAL_NETWORK: public
      - functest-pi-VOLUME_DEVICE_NAME:
          VOLUME_DEVICE_NAME: sdb
      - functest-pi-IMAGE_PROPERTIES:
          IMAGE_PROPERTIES: hw_scsi_model:virtio-scsi,hw_disk_bus:scsi
    builders:
      - functest-pi-run-containers:
          <<: *functest-pi-run-containers
          test: '{test}'

- project:
    name: 'functest-pi-ollivier-functest-smoke'
    <<: *functest-pi-ollivier-functest-smoke-params
    volumes:
      - /home/opnfv/functest/openstack.creds:/home/opnfv/functest/conf/env_file
      - /home/opnfv/functest/images:/home/opnfv/functest/images
    env:
      - EXTERNAL_NETWORK=$EXTERNAL_NETWORK
      - VOLUME_DEVICE_NAME=$VOLUME_DEVICE_NAME
      - IMAGE_PROPERTIES=$IMAGE_PROPERTIES
    published_ports:
    container: 'functest-smoke'
    test:
      - tempest_neutron
      - tempest_cinder
      - tempest_keystone
      - tempest_heat
      - tempest_telemetry
      - rally_sanity
      - refstack_compute
      - refstack_object
      - refstack_platform
      - tempest_full
      - tempest_scenario
      - tempest_slow
      - patrole_admin
      - patrole_member
      - patrole_reader
      - tempest_barbican
      - tempest_octavia
      - tempest_cyborg
    privileged: 'false'
    network: bridge
    uid: 1000
    gid: 1000
    jobs:
      - 'functest-pi-ollivier-functest-smoke-{tag}-{test}-run'

- job-template:
    name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-{test}-run'
    parameters:
      - functest-pi-node:
          node: '{node}'
      - functest-pi-build_tag:
          build_tag: ''
      - functest-pi-EXTERNAL_NETWORK:
          EXTERNAL_NETWORK: public
      - functest-pi-VOLUME_DEVICE_NAME:
          VOLUME_DEVICE_NAME: sdb
      - functest-pi-IMAGE_PROPERTIES:
          IMAGE_PROPERTIES: hw_scsi_model:virtio-scsi,hw_disk_bus:scsi
    builders:
      - functest-pi-run-containers:
          <<: *functest-pi-run-containers
          test: '{test}'

- project:
    name: 'functest-pi-ollivier-functest-smoke-cntt'
    <<: *functest-pi-ollivier-functest-smoke-cntt-params
    volumes:
      - /home/opnfv/functest/openstack.creds:/home/opnfv/functest/conf/env_file
      - /home/opnfv/functest/images:/home/opnfv/functest/images
    env:
      - EXTERNAL_NETWORK=$EXTERNAL_NETWORK
      - VOLUME_DEVICE_NAME=$VOLUME_DEVICE_NAME
      - IMAGE_PROPERTIES=$IMAGE_PROPERTIES
    published_ports:
    container: 'functest-smoke-cntt'
    test:
      - tempest_neutron_cntt
      - tempest_cinder_cntt
      - tempest_keystone_cntt
      - tempest_heat_cntt
      - rally_sanity_cntt
      - tempest_full_cntt
      - tempest_scenario_cntt
      - tempest_slow_cntt
    privileged: 'false'
    network: bridge
    uid: 1000
    gid: 1000
    jobs:
      - 'functest-pi-ollivier-functest-smoke-cntt-{tag}-{test}-run'

- job-template:
    name: 'functest-pi-ollivier-functest-benchmarking-{tag}-{test}-run'
    parameters:
      - functest-pi-node:
          node: '{node}'
      - functest-pi-build_tag:
          build_tag: ''
      - functest-pi-EXTERNAL_NETWORK:
          EXTERNAL_NETWORK: public
      - functest-pi-VOLUME_DEVICE_NAME:
          VOLUME_DEVICE_NAME: sdb
      - functest-pi-IMAGE_PROPERTIES:
          IMAGE_PROPERTIES: hw_scsi_model:virtio-scsi,hw_disk_bus:scsi
    builders:
      - functest-pi-run-containers:
          <<: *functest-pi-run-containers
          test: '{test}'

- project:
    name: 'functest-pi-ollivier-functest-benchmarking'
    <<: *functest-pi-ollivier-functest-benchmarking-params
    volumes:
      - /home/opnfv/functest/openstack.creds:/home/opnfv/functest/conf/env_file
      - /home/opnfv/functest/images:/home/opnfv/functest/images
    env:
      - EXTERNAL_NETWORK=$EXTERNAL_NETWORK
      - VOLUME_DEVICE_NAME=$VOLUME_DEVICE_NAME
      - IMAGE_PROPERTIES=$IMAGE_PROPERTIES
    published_ports:
    container: 'functest-benchmarking'
    test:
      - rally_full
      - rally_jobs
      - vmtp
      - shaker
    privileged: 'false'
    network: bridge
    uid: 1000
    gid: 1000
    jobs:
      - 'functest-pi-ollivier-functest-benchmarking-{tag}-{test}-run'

- job-template:
    name: 'functest-pi-ollivier-functest-benchmarking-cntt-{tag}-{test}-run'
    parameters:
      - functest-pi-node:
          node: '{node}'
      - functest-pi-build_tag:
          build_tag: ''
      - functest-pi-EXTERNAL_NETWORK:
          EXTERNAL_NETWORK: public
      - functest-pi-VOLUME_DEVICE_NAME:
          VOLUME_DEVICE_NAME: sdb
      - functest-pi-IMAGE_PROPERTIES:
          IMAGE_PROPERTIES: hw_scsi_model:virtio-scsi,hw_disk_bus:scsi
    builders:
      - functest-pi-run-containers:
          <<: *functest-pi-run-containers
          test: '{test}'

- project:
    name: 'functest-pi-ollivier-functest-benchmarking-cntt'
    <<: *functest-pi-ollivier-functest-benchmarking-cntt-params
    volumes:
      - /home/opnfv/functest/openstack.creds:/home/opnfv/functest/conf/env_file
      - /home/opnfv/functest/images:/home/opnfv/functest/images
    env:
      - EXTERNAL_NETWORK=$EXTERNAL_NETWORK
      - VOLUME_DEVICE_NAME=$VOLUME_DEVICE_NAME
      - IMAGE_PROPERTIES=$IMAGE_PROPERTIES
    published_ports:
    container: 'functest-benchmarking-cntt'
    test:
      - rally_full_cntt
      - rally_jobs_cntt
    privileged: 'false'
    network: bridge
    uid: 1000
    gid: 1000
    jobs:
      - 'functest-pi-ollivier-functest-benchmarking-cntt-{tag}-{test}-run'

- job-template:
    name: 'functest-pi-ollivier-functest-vnf-{tag}-{test}-run'
    parameters:
      - functest-pi-node:
          node: '{node}'
      - functest-pi-build_tag:
          build_tag: ''
      - functest-pi-EXTERNAL_NETWORK:
          EXTERNAL_NETWORK: public
      - functest-pi-VOLUME_DEVICE_NAME:
          VOLUME_DEVICE_NAME: sdb
      - functest-pi-IMAGE_PROPERTIES:
          IMAGE_PROPERTIES: hw_scsi_model:virtio-scsi,hw_disk_bus:scsi
    builders:
      - functest-pi-run-containers:
          <<: *functest-pi-run-containers
          test: '{test}'

- project:
    name: 'functest-pi-ollivier-functest-vnf'
    <<: *functest-pi-ollivier-functest-vnf-params
    volumes:
      - /home/opnfv/functest/openstack.creds:/home/opnfv/functest/conf/env_file
      - /home/opnfv/functest/images:/home/opnfv/functest/images
    env:
      - EXTERNAL_NETWORK=$EXTERNAL_NETWORK
      - VOLUME_DEVICE_NAME=$VOLUME_DEVICE_NAME
      - IMAGE_PROPERTIES=$IMAGE_PROPERTIES
    published_ports:
    container: 'functest-vnf'
    test:
      - cloudify
      - cloudify_ims
      - heat_ims
      - vyos_vrouter
      - juju_epc
    privileged: 'false'
    network: bridge
    uid: 1000
    gid: 1000
    jobs:
      - 'functest-pi-ollivier-functest-vnf-{tag}-{test}-run'

- builder:
    name: functest-pi-zip
    builders:
      - shell: |
          set +x
          volumes=;
          if [ "{volumes}" != "None" ]; then
            for i in $(echo {volumes} | tr -d '[]' |sed "s/, / /g" ); \
              do volumes="-v $i $volumes"; done
          fi
          env=;
          if [ "{env}" != "None" ]; then
            for i in $(eval echo {env} | tr -d '[]' |sed "s/, / /g" ); \
              do env="-e $i $env"; done
          fi
          published_ports=;
          if [ "{published_ports}" != "None" ]; then
            for i in $(echo {published_ports} | tr -d '[]' |sed "s/, / /g" ); \
              do published_ports="-p $i $published_ports"; done
          fi
          [ ! -z "$WORKSPACE" ] && sudo rm -rf $WORKSPACE/results || true
          if [ "{repo}" = "_" ]; then
            image={container}:{tag}
          elif [ "{port}" = "None" ]; then
            image={repo}/{container}:{tag}
          else
            image={repo}:{port}/{container}:{tag}
          fi
          sudo mkdir -p $WORKSPACE/results
          sudo chown {uid}:{gid} $WORKSPACE/results
          sudo docker run --rm \
            --privileged={privileged} \
            --network={network} \
            $volumes \
            $env \
            $published_ports \
            -e S3_ENDPOINT_URL=https://storage.googleapis.com \
            -e S3_DST_URL=s3://artifacts.opnfv.org/functest \
            -e HTTP_DST_URL=http://artifacts.opnfv.org/functest \
            -v /home/opnfv/functest/.boto:/etc/boto.cfg \
            -e TEST_DB_URL=http://testresults.opnfv.org/test/api/v1/results \
            -e TEST_DB_EXT_URL=http://testresults.opnfv.org/test/api/v1/results \
            -e NODE_NAME=$node \
            -e BUILD_TAG=$BUILD_TAG \
            -v $WORKSPACE/../$JOB_NAME/results:/var/lib/xtesting/results \
            -e DASHBOARD_URL={DASHBOARD_URL} \
            $image zip_campaign

- job-template:
    name: 'functest-pi-{tag}-zip'
    parameters:
      - functest-pi-node:
          node: '{node}'
      - functest-pi-build_tag:
          build_tag: ''
      - functest-pi-EXTERNAL_NETWORK:
          EXTERNAL_NETWORK: public
      - functest-pi-VOLUME_DEVICE_NAME:
          VOLUME_DEVICE_NAME: sdb
      - functest-pi-IMAGE_PROPERTIES:
          IMAGE_PROPERTIES: hw_scsi_model:virtio-scsi,hw_disk_bus:scsi
    builders:
      - functest-pi-zip:
          <<: *functest-pi-run-containers

- project:
    name: 'functest-pi-zip'
    <<: *functest-pi-ollivier-functest-healthcheck-params
    volumes:
      - /home/opnfv/functest/openstack.creds:/home/opnfv/functest/conf/env_file
      - /home/opnfv/functest/images:/home/opnfv/functest/images
    env:
      - EXTERNAL_NETWORK=$EXTERNAL_NETWORK
      - VOLUME_DEVICE_NAME=$VOLUME_DEVICE_NAME
      - IMAGE_PROPERTIES=$IMAGE_PROPERTIES
    published_ports:
    container: 'functest-healthcheck'
    privileged: 'false'
    network: bridge
    uid: 1000
    gid: 1000
    jobs:
      - 'functest-pi-{tag}-zip'

- job-template:
    name: 'functest-pi-{tag}-daily'
    project-type: multijob
    triggers:
      - timed: '@weekly'
    parameters:
      - functest-pi-node:
          node: '{node}'
      - functest-pi-build_tag:
          build_tag: ''
      - functest-pi-EXTERNAL_NETWORK:
          EXTERNAL_NETWORK: public
      - functest-pi-VOLUME_DEVICE_NAME:
          VOLUME_DEVICE_NAME: sdb
      - functest-pi-IMAGE_PROPERTIES:
          IMAGE_PROPERTIES: hw_scsi_model:virtio-scsi,hw_disk_bus:scsi
    # PyYAML and yamllint differ here
    # see https://github.com/yaml/pyyaml/issues/234
    # yamllint disable rule:indentation
    properties:
      - build-blocker:
          blocking-jobs:
          - ^functest-(pi-)*{tag}-(daily|docker|review)$
    # yamllint enable rule:indentation
    builders:
      - multijob:
          name: remove former images
          projects:
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-rmi'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-rmi'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-rmi'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-benchmarking-{tag}-rmi'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-benchmarking-cntt-{tag}-rmi'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-vnf-{tag}-rmi'
              <<: *functest-pi-jobs
      - multijob:
          name: pull containers
          projects:
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-pull'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-pull'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-pull'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-benchmarking-{tag}-pull'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-benchmarking-cntt-{tag}-pull'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-vnf-{tag}-pull'
              <<: *functest-pi-jobs
      - multijob:
          name: ollivier/functest-healthcheck:{tag}
          projects:
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-connection_check-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-tenantnetwork1-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-tenantnetwork2-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-vmready1-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-vmready2-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-singlevm1-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-singlevm2-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-vping_ssh-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-vping_userdata-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-cinder_test-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-odl-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-tempest_smoke-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-healthcheck-{tag}-tempest_horizon-run'
              <<: *functest-pi-jobs
      - multijob:
          name: ollivier/functest-smoke:{tag}
          projects:
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-tempest_neutron-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-tempest_cinder-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-tempest_keystone-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-tempest_heat-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-tempest_telemetry-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-rally_sanity-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-refstack_compute-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-refstack_object-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-refstack_platform-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-tempest_full-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-tempest_scenario-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-tempest_slow-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-patrole_admin-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-patrole_member-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-patrole_reader-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-tempest_barbican-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-tempest_octavia-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-{tag}-tempest_cyborg-run'
              <<: *functest-pi-jobs
      - multijob:
          name: ollivier/functest-smoke-cntt:{tag}
          projects:
            - name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-tempest_neutron_cntt-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-tempest_cinder_cntt-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-tempest_keystone_cntt-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-tempest_heat_cntt-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-rally_sanity_cntt-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-tempest_full_cntt-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-tempest_scenario_cntt-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-smoke-cntt-{tag}-tempest_slow_cntt-run'
              <<: *functest-pi-jobs
      - multijob:
          name: ollivier/functest-benchmarking:{tag}
          projects:
            - name: 'functest-pi-ollivier-functest-benchmarking-{tag}-rally_full-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-benchmarking-{tag}-rally_jobs-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-benchmarking-{tag}-vmtp-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-benchmarking-{tag}-shaker-run'
              <<: *functest-pi-jobs
      - multijob:
          name: ollivier/functest-benchmarking-cntt:{tag}
          projects:
            - name: 'functest-pi-ollivier-functest-benchmarking-cntt-{tag}-rally_full_cntt-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-benchmarking-cntt-{tag}-rally_jobs_cntt-run'
              <<: *functest-pi-jobs
      - multijob:
          name: ollivier/functest-vnf:{tag}
          projects:
            - name: 'functest-pi-ollivier-functest-vnf-{tag}-cloudify-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-vnf-{tag}-cloudify_ims-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-vnf-{tag}-heat_ims-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-vnf-{tag}-vyos_vrouter-run'
              <<: *functest-pi-jobs
            - name: 'functest-pi-ollivier-functest-vnf-{tag}-juju_epc-run'
              <<: *functest-pi-jobs
      - multijob:
          name: dump all campaign data
          projects:
            - name: 'functest-pi-{tag}-zip'
              <<: *functest-pi-jobs
    publishers:
      - email-ext:
          failure: false
          first-failure: true
          fixed: true
          recipients: cedric.ollivier@orange.com

- project:
    name: 'functest-pi-daily'
    <<: *functest-pi-params
    jobs:
      - 'functest-pi-{tag}-daily'

- view:
    name: functest-pi
    view-type: list
    columns:
      - status
      - weather
      - job
      - last-success
      - last-failure
      - last-duration
    regex: ^functest-pi-[a-z-0-9.]+-daily$

---
- scm:
    name: xtesting-ci-vm-scm
    scm:
      - git:
          url: https://github.com/collivier/ansible-role-xtesting.git
          branches:
            - master
          git-config-name:
          git-config-email:

- scm:
    name: xtesting-vm-scm
    scm:
      - git:
          url: https://git.opnfv.org/functest-xtesting.git
          branches:
            - master
          git-config-name:
          git-config-email:

- scm:
    name: functest-vm-scm
    scm:
      - git:
          url: https://git.opnfv.org/functest.git
          branches:
            - master
          git-config-name:
          git-config-email:

- scm:
    name: functest-kubernetes-vm-scm
    scm:
      - git:
          url: https://git.opnfv.org/functest-kubernetes.git
          branches:
            - master
          git-config-name:
          git-config-email:

- builder:
    name: xtesting-ci-vm-builder
    builders:
      - shell: |
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
          echo "deb https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee \
            /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get -o DPkg::Lock::Timeout=300 update && \
          DEBIAN_FRONTEND=noninteractive sudo apt-get \
            -o DPkg::Lock::Timeout=300 install python3-diskimage-builder -y
          if [ {project} == "xtestingci" ]; then
            export ELEMENTS_PATH=$(pwd)/elements
          else
            git clone https://github.com/collivier/ansible-role-xtesting.git
-           export ELEMENTS_PATH=$(pwd)/elements:$(pwd)/ansible-role-xtesting/elements
          fi
          disk-image-create --image-size 20 -o {project}-{version}.qcow2 debian vm {project}
          gsutil cp {project}-{version}.qcow2 gs://artifacts.opnfv.org/{project}/{project}-{version}.qcow2

- trigger:
    name: xtesting-ci-vm-trigger
    triggers:
      - timed: '@daily'

- parameter:
    name: xtesting-ci-vm-parameter
    parameters:
      - label:
          name: node
          default: 'opnfv-build'

- job-template:
    name: 'xtesting-ci-vm'
    scm:
      - xtesting-ci-vm-scm
    triggers:
      - xtesting-ci-vm-trigger
    parameters:
      - xtesting-ci-vm-parameter
    properties:
      - build-blocker:
          use-build-blocker: true
          blocking-level: 'NODE'
          blocking-jobs:
            - '^.*-vm$'
    builders:
      - xtesting-ci-vm-builder:
          project: xtestingci
          version: 4.1.0

- job-template:
    name: 'xtesting-vm'
    scm:
      - xtesting-vm-scm
    triggers:
      - xtesting-ci-vm-trigger
    parameters:
      - xtesting-ci-vm-parameter
    builders:
      - xtesting-ci-vm-builder:
          project: xtesting
          version: latest

- job-template:
    name: 'functest-vm'
    scm:
      - functest-vm-scm
    triggers:
      - xtesting-ci-vm-trigger
    parameters:
      - xtesting-ci-vm-parameter
    builders:
      - xtesting-ci-vm-builder:
          project: functest
          version: latest

- job-template:
    name: 'functest-kubernetes-vm'
    scm:
      - functest-kubernetes-vm-scm
    triggers:
      - xtesting-ci-vm-trigger
    parameters:
      - xtesting-ci-vm-parameter
    builders:
      - xtesting-ci-vm-builder:
          project: functest-kubernetes
          version: latest

- project:
    name: 'xtesting-ci-vm'
    jobs:
      - 'xtesting-ci-vm'
      - 'xtesting-vm'
      - 'functest-vm'
      - 'functest-kubernetes-vm'

- view:
    name: xtesting-ci-vm
    view-type: list
    columns:
      - status
      - weather
      - job
      - last-success
      - last-failure
      - last-duration
    regex: ^.*-vm$

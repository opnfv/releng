---
- project:
    name: nfvbench

    project: '{name}'

    jobs:
      - 'nfvbench-build-{stream}'
      - 'nfvbench-verify-{stream}'
      - 'nfvbench-docker-build-push-{stream}'


    stream:
      - master:
          branch: '{stream}'
          gs-pathname: ''
          docker-tag: 'latest'
          disabled: false
      - fraser: &fraser
          branch: 'stable/{stream}'
          gs-pathname: '/{stream}'
          docker-tag: 'stable'
          disabled: false

- job-template:
    name: 'nfvbench-build-{stream}'

    disabled: '{obj:disabled}'

    parameters:
      - project-parameter:
          project: '{project}'
          branch: '{branch}'
      # yamllint disable rule:line-length
      - string:
          name: GIT_BASE
          default: https://gerrit.opnfv.org/gerrit/$PROJECT
          description: "Used for overriding the GIT URL coming from Global Jenkins configuration in case if the stuff is done on none-LF HW."
      # yamllint enable rule:line-length
      - 'opnfv-build-ubuntu-defaults'

    scm:
      - git-scm-gerrit

    triggers:
      - gerrit:
          server-name: 'gerrit.opnfv.org'
          trigger-on:
            - comment-added-contains-event:
                comment-contains-value: 'buildvm'
          projects:
            - project-compare-type: 'ANT'
              project-pattern: '{project}'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern: '**/{branch}'

    builders:
      - shell: |
          cd $WORKSPACE/nfvbenchvm/dib
          bash build-image.sh

- job-template:
    name: 'nfvbench-verify-{stream}'

    disabled: '{obj:disabled}'

    parameters:
      - project-parameter:
          project: '{project}'
          branch: '{branch}'
      # yamllint disable rule:line-length
      - string:
          name: GIT_BASE
          default: https://gerrit.opnfv.org/gerrit/$PROJECT
          description: "Used for overriding the GIT URL coming from Global Jenkins configuration in case if the stuff is done on none-LF HW."
      # yamllint enable rule:line-length
      - 'opnfv-build-ubuntu-defaults'

    scm:
      - git-scm-gerrit

    triggers:
      - gerrit:
          server-name: 'gerrit.opnfv.org'
          trigger-on:
            - patchset-created-event:
                exclude-drafts: 'false'
                exclude-trivial-rebase: 'false'
                exclude-no-code-change: 'false'
          projects:
            - project-compare-type: 'ANT'
              project-pattern: '{project}'
              branches:
                - branch-compare-type: 'ANT'
                  branch-pattern: '**/{branch}'

    builders:
      - shell: |
          cd $WORKSPACE && tox

- job-template:
    name: 'nfvbench-docker-build-push-{stream}'

    disabled: '{obj:disabled}'

    parameters: &parameters
      - project-parameter:
          project: '{project}'
          branch: '{branch}'
      - 'opnfv-build-ubuntu-defaults'
      - string:
          name: PUSH_IMAGE
          default: "true"
          description: "To enable/disable pushing the image to Dockerhub."
      - string:
          name: DOCKER_REPO_NAME
          default: "opnfv/{dockerrepo}"
          description: "Dockerhub repo to be pushed to."
      - string:
          name: DOCKER_DIR
          default: "{dockerdir}"
          description: "Directory containing files needed by the Dockerfile"
      - string:
          name: COMMIT_ID
          default: ""
          description: "commit id to make a snapshot docker image"
      - string:
          name: GERRIT_REFNAME
          default: ""
          description: "Docker tag to be built, e.g. refs/tags/5.0.0, refs/tags/opnfv-5.0.0, refs/tags/5.0.RC1"
      - string:
          name: DOCKERFILE
          default: "{dockerfile}"
          description: "Dockerfile to use for creating the image."
      - string:
          name: ARCH_TAG
          default: "{arch_tag}"
          description: "If set, this value will be added to the docker image tag as a prefix"

    properties:
      - throttle:
          max-per-node: 1
          option: 'project'

    scm:
      - git-scm

    builders: &builders
      - shell:
          !include-raw-escape: ./opnfv-docker.sh

    triggers:
      - pollscm:
          cron: "*/30 * * * *"
      - gerrit-trigger-tag-created:
          project: '{project}'

    publishers:
      - email:
          recipients: '{receivers}'
      - email-jenkins-admins-on-failure


---
- hosts: jumphost
  remote_user: root
  vars_files:
    - ../var/ubuntu.yml
  tasks:
  - name: Generate SSH keys
    shell: ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N ""
    args:
      creates: /root/.ssh/id_rsa
  - name:  fetch public key
    fetch: src="/root/.ssh/id_rsa.pub" dest="/"
  - name: remove the dirctory
    shell: " rm -rf {{OSA_PATH}} {{OSA_ETC_PATH}}"
  - name: git openstack ansiblt
    shell: "git clone {{OSA_URL}} {{OSA_PATH}}"
  - name: copy the /etc/openstack
    shell: "/bin/cp -rf {{OSA_PATH}}/etc/openstack_deploy {{OSA_ETC_PATH}}"
  - name: bootstrap
    command: "/bin/bash ./scripts/bootstrap-ansible.sh"
    args:
      chdir: "{{OSA_PATH}}"
  - name: password token
    command: "python pw-token-gen.py --file /etc/openstack_deploy/user_secrets.yml"
    args:
      chdir: /opt/openstack-ansible/scripts/
  - name: configuration openstack_user
    template: src=../template/openstack_user_config.yml.temp dest="{{OSA_ETC_PATH}}/openstack_user_config.yml"
  - name: configuration cinder
    template: src=../template/cinder.yml.temp dest="{{OSA_ETC_PATH}}/env.d/cinder.yml"
  - name: configuration  user_variables
    template: src=../template/user_variables.yml.temp dest="{{OSA_ETC_PATH}}/user_variables.yml"
  - name: conf interface
    template: src=../template/bifrost/jump.interfaces.temp dest=/etc/network/interfaces
    notify:
    - restart network
  handlers:
    - name: restart network
      shell: "/sbin/ifconfig ens3 0 &&/sbin/ifdown -a && /sbin/ifup -a"

- hosts: localhost
  remote_user: root
  tasks:
  - name: Generate authorized_keys
    shell: "/bin/cat /192.168.122.2/root/.ssh/id_rsa.pub >> ../template/authorized_keys.temp"
- hosts: compute1
  remote_user: root
  tasks:
  - name: add public key to host
    template: src=../template/authorized_keys.temp dest=/root/.ssh/authorized_keys
